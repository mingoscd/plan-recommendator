<button class="js-geolocation"><span class="fa fa-refresh"></span></button>
<button class="js-filter-elements filter-elements"><span class="fa fa-filter"></span></button>
<ul class="filter-menu">
	<li><button class="filter-elements"><span class="fa fa-bank"></span></button></li>
	<li><button class="filter-elements"><span class="fa fa-cutlery"></span></button></li>
	<li><button class="filter-elements"><span class="fa fa-tree"></span></button></li>
</ul>


<div id="map" style="position: fixed; bottom: 0;"></div>
<script>
	$(document).ready(function(){
		var map;
		nearPageStyle();
		navigator.geolocation.getCurrentPosition(getMap);
		//binding the button to the refresh of the map
		$(".js-geolocation").click(function(){ 
			navigator.geolocation.getCurrentPosition(getMap);
		});
		//resizing the window
		$(window).resize(function(){ 
			navigator.geolocation.getCurrentPosition(getMap);
		});
		$(".js-filter-elements").click(function(){
			$(".filter-elements").toggleClass("active");
		});
	});
	function getMap(e){
		var lon = e.coords.longitude;
		var lat = e.coords.latitude;

		//async call, when the response arrive, the other code has been executed
		var query = '<%= api_v1_near_path %>';
		$.ajax({ dataType: "json", data: { lat: lat, lon: lon }, url: query}).done(function(places){
			for(var i=0; i< places.length; i++){
				var price = places[i].price > 0 ? places[i].price+" "+places[i].currency+"s" : "FREE";
				switch(places[i].type_of_site){
					case "Monument": icon = "http://destinationusa.info/images/icon-museum.gif"; break; 
					case "Park": icon = "https://encrypted-tbn2.gstatic.com/images?q=tbn:ANd9GcQhI_h49x0CHHlo6k_ibJ-I1iaLAePmISsx8u1zK6LiACTmBCjjgg"; break;
					case "Bar": icon = "http://tullegada.com/portal/images/iconos/hospedaje/icon-bar.png"; break;
					case "Cafe": icon = "http://www.leics.gov.uk/cafe_icon.jpg"; break;
					case "Theater": icon = "http://www.develsergemeenschap.nl/content/img/theater-icon.png"; break;
					case "Food/Restaurant": icon = "http://www.chefirie.com/wp-content/uploads/2013/08/Restaurant-Blue-icon-sm.png"; break;
					default: icon = "http://www.physicianoneurgentcare.com/_global/img/template/map-marker.png";
				}
				map.addMarker({ lat: places[i].lat, lng: places[i].lon,	icon: icon, infoWindow: { content: '<h3>'+places[i].name+'</h3><p>'+places[i].address+'</p><span>'+price+'</span>'},});
			}
		});
		//map styles
		var element = '#map';
		var hei = window.innerHeight - 64;
		var wid = window.innerWidth;
		$(element).css('width', wid+'px').css('height', hei+'px');

		//creating the map
		map = new GMaps({el: '#map', lat: lat, lng: lon, zoom: 16, width: wid, height: hei });

		//user marker
		var icon = 'http://pinkkittyrose.com/forums/images/smilies/64_pokeball.png';
		var animation = google.maps.Animation.BOUNCE;
		map.addMarker({ lat: lat, lng: lon, title: 'YOU', icon: icon, animation: animation });	
	}
	function nearPageStyle(){
		$("body").css('overflow-y','hidden');
		$(".main-content").css('margin-top', '3em').css('padding','0');
		$("button").addClass("geobutton");
	}
</script>